---
- name: Crear usuario redmine
  ansible.builtin.user:
    name: redmine 
    shell: /bin/bash 
    groups: users
    create_home: true
    state: present

- name: Agregar el usuario {{ redmine_user }} al grupo www-data
  ansible.builtin.user:
    name: '{{ redmine_user }}'
    groups: www-data
    append: yes

- name: Descargar Redmine
  get_url:
    url: '{{ redmine_url }}'
    dest: /tmp/redmine.tar.gz

- name: Extraer Redmine en /opt/redmine-6.0.6
  unarchive:
    src: /tmp/redmine.tar.gz
    dest: "/opt"
    remote_src: yes

- name: Cambiar propietario, grupo y permisos de /opt/redmine-6.0.6
  ansible.builtin.file:
    path: "{{ redmine_root_dir }}"
    owner: '{{ redmine_user }}'
    group: www-data
    mode: '0777'
    recurse: yes

- name: Instalar paquetes básicos
  apt:
    name:
      - build-essential
      - curl
      - git
      - libmariadb-dev
      #- libmysqlclient-dev
    state: present
    update_cache: true

- name: Clonar asdf en el home de {{ redmine_user }}
  become: true
  become_user: '{{ redmine_user }}'
  git:
    repo: 'https://github.com/asdf-vm/asdf.git'
    dest: '/home/{{ redmine_user }}/.asdf'
    version: '{{ asdf_version }}'

- name: Configurar bashrc para asdf
  lineinfile:
    path: '/home/{{ redmine_user }}/.bashrc'
    line: '{{ item }}'
    create: yes
  loop:
    - '. "/home/{{ redmine_user }}/.asdf/asdf.sh"'
    - '. "/home/{{ redmine_user }}/.asdf/completions/asdf.bash"'
  become: true
  become_user: '{{ redmine_user }}'

- name: Instalar dependencias para Ruby y Redmine
  apt:
    name:
      - libssl-dev
      - libyaml-dev
      - libreadline6-dev
      - zlib1g-dev
      - libgmp-dev
      - libncurses5-dev
      - libffi-dev
      - libgdbm6
      - libgdbm-dev
      - libdb-dev
      - uuid-dev
    state: present

- name: Instalar plugin ruby en asdf y Ruby {{ ruby_version }}
  become: true
  become_user: "{{ redmine_user }}"
  shell: |
    export ASDF_DIR="$HOME/.asdf"
    . "$ASDF_DIR/asdf.sh"
    . "$ASDF_DIR/completions/asdf.bash"
    asdf plugin add ruby || true
    asdf install ruby {{ ruby_version }}
    asdf global ruby {{ ruby_version }}
    gem install bundler
  args:
    executable: /bin/bash

- name: Se configura database.yml en Redmine
  ansible.builtin.template:
    src: "database.yml.j2"
    dest: "{{ redmine_root_dir }}/config/database.yml"

- name: Instalar dependencias con Bundler
  become: true
  become_user: "{{ redmine_user }}"
  shell: |
    /home/ubuntu/.asdf/shims/bundle config set --local without "development test"
    bash -lc 'PATH=$PATH:/home/ubuntu/.asdf/bin && /home/ubuntu/.asdf/shims/bundle install'
  args:
    chdir: "{{ redmine_root_dir }}"

- name: Generar secret token
  become: true
  become_user: "{{ redmine_user }}"
  shell: /home/ubuntu/.asdf/shims/bundle exec rake generate_secret_token
  args:
    chdir: "{{ redmine_root_dir }}"
    executable: /bin/bash

- name: Ejecutar migraciones de base de datos
  become: true
  become_user: "{{ redmine_user }}"
  shell: RAILS_ENV=production bundle exec rake db:migrate
  args:
    chdir: "{{ redmine_root_dir }}"
    executable: /bin/bash

- name: Cargar datos por defecto en español
  become: true
  become_user: "{{ redmine_user }}"
  shell: |
    echo "es" | RAILS_ENV=production /home/ubuntu/.asdf/shims/bundle exec rake redmine:load_default_data
  args:
    chdir: "{{ redmine_root_dir }}"
    executable: /bin/bash

- name: Se configura redmine.service 
  ansible.builtin.template:
    src: "redmine.service.j2"
    dest: "/etc/systemd/system/redmine.service"
  notify: Reload systemd

- name: Iniciar el servicio redmine.service
  ansible.builtin.systemd:
    name: redmine.service
    enabled: true
    state: started
  become: true

