---
- name: Crear grupo {{ redmine_group }}
  ansible.builtin.group:
    name: '{{ redmine_group }}'
    state: present

- name: Crear usuario {{ redmine_user }}
  ansible.builtin.user:
    name: '{{ redmine_user }}'
    shell: /bin/bash 
    groups: '{{ redmine_group }}'
    create_home: true
    state: present

- name: Descargar Redmine
  ansible.builtin.get_url:
    url: '{{ redmine_url }}'
    dest: /tmp/redmine.tar.gz

- name: Extraer Redmine en {{ redmine_root_dir }} 
  ansible.builtin.unarchive:
    src: /tmp/redmine.tar.gz
    dest: "/opt"
    remote_src: yes
    creates: '{{ redmine_root_dir }}'

- name: Cambiar propietario, grupo y permisos de {{ redmine_root_dir }}
  ansible.builtin.file:
    path: "{{ redmine_root_dir }}"
    owner: '{{ redmine_user }}'
    group: '{{ redmine_group }}'
    mode: '0755'
    #recurse: yes

- name: Instalar paquetes básicos
  apt:
    name:
      - acl
      - build-essential
      - curl
      - git
      - libmariadb-dev
      #- libmysqlclient-dev
    state: present
    update_cache: true

- name: Clonar asdf en el home de {{ redmine_user }}
  #become: true
  become_user: '{{ redmine_user }}'
  git:
    repo: 'https://github.com/asdf-vm/asdf.git'
    dest: '/home/{{ redmine_user }}/.asdf'
    version: '{{ asdf_version }}'

- name: Configurar bashrc para asdf
  become_user: '{{ redmine_user }}'
  lineinfile:
    path: '/home/{{ redmine_user }}/.bashrc'
    line: '{{ item }}'
    create: yes
  loop:
    - '. "/home/{{ redmine_user }}/.asdf/asdf.sh"'
    - '. "/home/{{ redmine_user }}/.asdf/completions/asdf.bash"'

- name: Instalar dependencias para Ruby y Redmine
  apt:
    name:
      - libssl-dev
      - libyaml-dev
      - libreadline6-dev
      - zlib1g-dev
      - libgmp-dev
      - libncurses5-dev
      - libffi-dev
      - libgdbm6
      - libgdbm-dev
      - libdb-dev
      - uuid-dev
    state: present

- name: Instalar plugin ruby en asdf y Ruby {{ ruby_version }}
  become_user: "{{ redmine_user }}"
  shell: |
    echo $HOME
    export ASDF_DIR="/home/{{ redmine_user }}/.asdf"
    . "$ASDF_DIR/asdf.sh"
    . "$ASDF_DIR/completions/asdf.bash"
    asdf plugin add ruby || true
    asdf install ruby {{ ruby_version }}
    asdf global ruby {{ ruby_version }}
    gem install bundler
  args:
    executable: /bin/bash
  environment:
    PATH: "/home/{{ redmine_user }}/.asdf/bin/:{{ ansible_env.PATH }}"

- name: Se configura database.yml en Redmine
  ansible.builtin.template:
    src: "database.yml.j2"
    dest: "{{ redmine_root_dir }}/config/database.yml"

- name: Se deshabilita la carga de contenido estatico desde Puma
  shell: |
    sed -i "s/^  # config.public_file_server.enabled/  config.public_file_server.enabled/" config/environments/production.rb
  args:
    chdir: "{{ redmine_root_dir }}"
    executable: /bin/bash

- name: Se aplica configuración de bundle al proyecto Redmine
  become_user: '{{ redmine_user }}'
  shell: |
    /home/{{ redmine_user }}/.asdf/shims/bundle config set --local without "development test"
  args:
    chdir: "{{ redmine_root_dir }}"
    executable: /bin/bash

- name: Se agrega Gemfile.local
  ansible.builtin.copy:
    mode: "0777"
    dest: "{{ redmine_root_dir }}/Gemfile.local"
    owner: '{{ redmine_user }}'
    group: '{{ redmine_group }}'
    content: |
      gem 'puma'

- name: Instalar dependencias con Bundler
  become_user: '{{ redmine_user }}'
  shell: |
    echo $PATH
    bash -lc 'PATH=$PATH:/home/{{ redmine_user }}/.asdf/bin && /home/{{ redmine_user }}/.asdf/shims/bundle install'
  args:
    chdir: "{{ redmine_root_dir }}"
    executable: /bin/bash

- name: Generar secret token
  become_user: '{{ redmine_user }}'
  shell: /home/{{ redmine_user }}/.asdf/shims/bundle exec rake generate_secret_token
  args:
    chdir: "{{ redmine_root_dir }}"

- name: Ejecutar migraciones de base de datos
  become_user: "{{ redmine_user }}"
  shell: RAILS_ENV=production /home/{{ redmine_user }}/.asdf/shims/bundle exec rake db:migrate
  args:
    chdir: "{{ redmine_root_dir }}"

- name: Cargar datos por defecto en español
  become_user: "{{ redmine_user }}"
  shell: |
    echo "es" | RAILS_ENV=production /home/{{ redmine_user }}/.asdf/shims/bundle exec rake redmine:load_default_data
  args:
    chdir: "{{ redmine_root_dir }}"
    executable: /bin/bash

- name: Se configura redmine.service
  ansible.builtin.template:
    src: "redmine.service.j2"
    dest: "/etc/systemd/system/redmine.service"
  notify: Reload systemd

- name: Iniciar el servicio redmine.service
  ansible.builtin.systemd:
    name: redmine.service
    enabled: true
    state: started

- name: Reiniar el servicio nginx.service
  ansible.builtin.systemd:
    name: nginx
    enabled: true
    state: restarted
